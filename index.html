import React, { useState, useEffect } from 'react';
import { Flame, Trophy } from 'lucide-react';

const KnightDuelGame = () => {
  const [board, setBoard] = useState(initializeBoard());
  const [currentPlayer, setCurrentPlayer] = useState(1);
  const [selectedSquare, setSelectedSquare] = useState(null);
  const [validMoves, setValidMoves] = useState([]);
  const [gameOver, setGameOver] = useState(false);
  const [winner, setWinner] = useState(null);
  const [moveHistory, setMoveHistory] = useState([]);

  function initializeBoard() {
    const newBoard = Array(8).fill(null).map(() => 
      Array(8).fill(null).map(() => ({ piece: null, burned: false }))
    );
    // Place knights at starting positions
    newBoard[0][1] = { piece: 1, burned: false }; // Player 1
    newBoard[7][6] = { piece: 2, burned: false }; // Player 2
    return newBoard;
  }

  function getKnightMoves(row, col) {
    const moves = [
      [-2, -1], [-2, 1], [-1, -2], [-1, 2],
      [1, -2], [1, 2], [2, -1], [2, 1]
    ];
    
    const validMoves = [];
    moves.forEach(([dr, dc]) => {
      const newRow = row + dr;
      const newCol = col + dc;
      
      if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
        const square = board[newRow][newCol];
        if (!square.burned) {
          validMoves.push([newRow, newCol]);
        }
      }
    });
    
    return validMoves;
  }

  function findKnight(player) {
    for (let row = 0; row < 8; row++) {
      for (let col = 0; col < 8; col++) {
        if (board[row][col].piece === player) {
          return [row, col];
        }
      }
    }
    return null;
  }

  function hasLegalMoves(player) {
    const pos = findKnight(player);
    if (!pos) return false;
    return getKnightMoves(pos[0], pos[1]).length > 0;
  }

  function handleSquareClick(row, col) {
    if (gameOver) return;

    const square = board[row][col];

    // If clicking on current player's knight
    if (square.piece === currentPlayer) {
      setSelectedSquare([row, col]);
      setValidMoves(getKnightMoves(row, col));
      return;
    }

    // If a square is selected and this is a valid move
    if (selectedSquare) {
      const isValidMove = validMoves.some(([r, c]) => r === row && c === col);
      
      if (isValidMove) {
        makeMove(selectedSquare, [row, col]);
      }
      
      setSelectedSquare(null);
      setValidMoves([]);
    }
  }

  function makeMove(from, to) {
    const [fromRow, fromCol] = from;
    const [toRow, toCol] = to;
    const newBoard = board.map(row => row.map(sq => ({ ...sq })));

    // Capture opponent's knight if present
    const capturedPiece = newBoard[toRow][toCol].piece;
    
    // Move knight
    newBoard[toRow][toCol] = { piece: currentPlayer, burned: false };
    
    // Burn previous square
    newBoard[fromRow][fromCol] = { piece: null, burned: true };

    setBoard(newBoard);
    setMoveHistory([...moveHistory, { player: currentPlayer, from, to, captured: capturedPiece }]);

    // Check win conditions
    if (capturedPiece) {
      setGameOver(true);
      setWinner(currentPlayer);
      return;
    }

    // Switch player
    const nextPlayer = currentPlayer === 1 ? 2 : 1;
    setCurrentPlayer(nextPlayer);

    // Check if next player has legal moves
    setTimeout(() => {
      const nextKnightPos = findKnight(nextPlayer);
      if (!nextKnightPos || getKnightMoves(nextKnightPos[0], nextKnightPos[1]).length === 0) {
        setGameOver(true);
        setWinner(currentPlayer);
      }
    }, 100);
  }

  function resetGame() {
    setBoard(initializeBoard());
    setCurrentPlayer(1);
    setSelectedSquare(null);
    setValidMoves([]);
    setGameOver(false);
    setWinner(null);
    setMoveHistory([]);
  }

  function getSquareColor(row, col) {
    return (row + col) % 2 === 0 ? 'bg-amber-100' : 'bg-amber-800';
  }

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 to-slate-700 p-4">
      <div className="mb-6 text-center">
        <h1 className="text-4xl font-bold text-white mb-2">Knight Duel</h1>
        <p className="text-slate-300">Two knights enter, one knight leaves</p>
      </div>

      {gameOver && (
        <div className="mb-4 bg-yellow-500 text-slate-900 px-6 py-3 rounded-lg font-bold text-xl flex items-center gap-2">
          <Trophy size={24} />
          Player {winner} Wins!
        </div>
      )}

      {!gameOver && (
        <div className="mb-4 bg-slate-800 text-white px-6 py-3 rounded-lg font-semibold">
          Current Turn: <span className={currentPlayer === 1 ? 'text-blue-400' : 'text-red-400'}>
            Player {currentPlayer}
          </span>
        </div>
      )}

      <div className="bg-slate-800 p-6 rounded-xl shadow-2xl">
        <div className="grid grid-cols-8 gap-0 border-4 border-slate-900">
          {board.map((row, rowIdx) => (
            row.map((square, colIdx) => {
              const isSelected = selectedSquare && selectedSquare[0] === rowIdx && selectedSquare[1] === colIdx;
              const isValidMove = validMoves.some(([r, c]) => r === rowIdx && c === colIdx);
              
              return (
                <div
                  key={`${rowIdx}-${colIdx}`}
                  onClick={() => handleSquareClick(rowIdx, colIdx)}
                  className={`
                    w-16 h-16 flex items-center justify-center cursor-pointer
                    ${getSquareColor(rowIdx, colIdx)}
                    ${isSelected ? 'ring-4 ring-yellow-400' : ''}
                    ${isValidMove ? 'ring-4 ring-green-400' : ''}
                    ${square.burned ? 'bg-gray-900' : ''}
                    transition-all hover:opacity-80
                  `}
                >
                  {square.burned && (
                    <Flame className="text-orange-500" size={32} />
                  )}
                  {square.piece === 1 && !square.burned && (
                    <div className="text-4xl">♞</div>
                  )}
                  {square.piece === 2 && !square.burned && (
                    <div className="text-4xl text-white">♞</div>
                  )}
                </div>
              );
            })
          ))}
        </div>
      </div>

      <button
        onClick={resetGame}
        className="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors"
      >
        New Game
      </button>

      <div className="mt-6 bg-slate-800 text-white p-4 rounded-lg max-w-md">
        <h3 className="font-bold mb-2">Rules:</h3>
        <ul className="text-sm space-y-1 text-slate-300">
          <li>• Click your knight to select it</li>
          <li>• Click a highlighted square to move</li>
          <li>• Squares burn after being vacated</li>
          <li>• Win by capturing opponent or trapping them</li>
        </ul>
      </div>
    </div>
  );
};

export default KnightDuelGame;
