<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess vs Stockfish (Black) - Custom FEN</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net">
    <script src="https://code.jquery.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net"></script>
</head>
<body>
    <div id="myBoard" style="width: 400px; margin: 20px auto;"></div>
    <div style="text-align: center; margin-top: 10px;">
        <button onclick="board.flip()">Flip Board</button>
        <button onclick="newGame()">New Game (FEN)</button>
        <p id="status">Loading...</p>
    </div>

    <script>
        // --- Configuration Variables ---
        // Your starting position: 'start' is the default. Change to any FEN string.
        let initialFen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
        const enginePath = 'https://cdnjs.cloudflare.com';
        
        let game = new Chess(initialFen);
        let board = null;
        const engine = new Worker(enginePath);

        // --- Core Functions ---

        function handleMove(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            
            document.getElementById('status').innerText = "Engine thinking...";
            window.setTimeout(requestEngineMove, 250);
        }

        function requestEngineMove() {
            engine.postMessage(`position fen ${game.fen()}`);
            engine.postMessage('go depth 12');
        }

        function newGame() {
            game = new Chess(initialFen);
            board.position(initialFen);
            document.getElementById('status').innerText = "New Game Started (You are White)";
        }

        // --- Engine Communication ---

        engine.onmessage = function(event) {
            if (event.data.startsWith('bestmove')) {
                const moveStr = event.data.split(' ')[1]; // e.g., "e7e5"
                game.move({
                    from: moveStr.substring(0, 2),
                    to: moveStr.substring(2, 4),
                    promotion: 'q'
                });
                board.position(game.fen());
                document.getElementById('status').innerText = "Your turn";
            }
        };

        // --- Initialization ---

        // Wait for everything to load before initializing
        window.onload = function() {
            board = Chessboard('myBoard', {
                draggable: true,
                position: initialFen,
                onDrop: handleMove,
                // FIX FOR BROKEN ICONS ON GITHUB PAGES:
                pieceTheme: 'https://chessboardjs.com{piece}.png'
            });

            // Start the engine
            engine.postMessage('uci'); 
            engine.postMessage('isready');

            document.getElementById('status').innerText = "Ready. Your turn to play (White).";
        };
    </script>
</body>
</html>
