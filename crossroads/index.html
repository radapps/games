<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BBS Mobile Client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>

<style>
body {
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  background:black;
  color:white;
  font-family: monospace;
}

#topbar {
  padding:6px;
  background:#222;
}

input, button {
  padding:8px;
  margin:3px 0;
  width:100%;
  font-size:16px;
}

#terminal {
  flex:1;
  overflow-y:auto;
  padding:10px;
  white-space:pre-wrap;
}

#controls {
  background:#111;
  padding:5px;
  display:grid;
  grid-template-columns: repeat(4,1fr);
  gap:6px;
}

.control-btn {
  font-size:18px;
  padding:12px;
}

.hidden { display:none; }

#keyboardInput {
  position:absolute;
  opacity:0;
}
</style>
</head>

<body>

<div id="topbar">
  <input id="wsurl" placeholder="wss://bbs.example.com/ws">
  <button onclick="connect()">Connect</button>
</div>

<div id="terminal"></div>

<div id="controls" class="hidden">
  <button class="control-btn" onclick="sendCmd('N')">â¬† N</button>
  <button class="control-btn" onclick="sendCmd('LOOK')">ğŸ‘</button>
  <button class="control-btn" onclick="sendCmd('S')">â¬‡ S</button>

  <button class="control-btn" onclick="sendCmd('W')">â¬… W</button>
  <button class="control-btn" onclick="sendCmd('HIT')">âš”</button>
  <button class="control-btn" onclick="sendCmd('E')">â¡ E</button>

  <button class="control-btn" onclick="sendCmd('U')">â¬† U</button>
  <button class="control-btn" onclick="sendCmd('SPELLS')">ğŸ“–</button>
  <button class="control-btn" onclick="sendCmd('D')">â¬‡ D</button>

  <button class="control-btn" onclick="sendCmd('I')">ğŸ’</button>
  <button class="control-btn" onclick="toggleKeyboard()">âŒ¨</button>
  <button class="control-btn" onclick="clearScreen()">ğŸ§¹</button>
</div>

<input id="keyboardInput">

<script>
const ansi = new AnsiUp();
const terminal = document.getElementById("terminal");
const keyboardInput = document.getElementById("keyboardInput");
let ws;

function connect() {
  const url = document.getElementById("wsurl").value;
  localStorage.setItem("wsurl", url);

  terminal.innerHTML += "*** Connecting... ***\n";

  ws = new WebSocket(url);
  ws.binaryType = "arraybuffer";

  ws.onopen = () => {
    terminal.innerHTML += "*** Connected ***\n";
    document.getElementById("controls").classList.remove("hidden");
  };

  ws.onmessage = evt => {
    const data = new Uint8Array(evt.data);
    const text = decodeTelnet(data);
    render(text);
    parseDynamic(text);
  };

  ws.onclose = () => {
    terminal.innerHTML += "\n*** Disconnected ***\n";
  };

  ws.onerror = e => {
    terminal.innerHTML += "\n*** WebSocket error ***\n";
  };
}

function sendCmd(cmd) {
  if (!ws || ws.readyState !== 1) return;
  ws.send(cmd + "\r\n");
}

function toggleKeyboard() {
  keyboardInput.focus();
}

keyboardInput.addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    sendCmd(keyboardInput.value);
    keyboardInput.value="";
  }
});

function clearScreen() {
  terminal.innerHTML = "";
}

function render(text) {
  const html = ansi.ansi_to_html(text);
  terminal.innerHTML += html;
  terminal.scrollTop = terminal.scrollHeight;
}

// Remove telnet IAC negotiation bytes
function decodeTelnet(data) {
  let result = "";
  for (let i = 0; i < data.length; i++) {
    if (data[i] === 255) { // IAC
      i += 2;
    } else {
      result += String.fromCharCode(data[i]);
    }
  }
  return result;
}

// Dynamic button logic
function parseDynamic(text) {
  if (text.includes("Exits:")) {
    updateExits(text);
  }
  if (text.includes("You are attacked")) {
    console.log("Combat mode");
  }
}

function updateExits(text) {
  const match = text.match(/Exits:(.*)/);
  if (!match) return;
  const exits = match[1];

  document.querySelectorAll(".control-btn").forEach(b=>b.disabled=false);

  if (!exits.includes("N")) disableBtn("â¬† N");
  if (!exits.includes("S")) disableBtn("â¬‡ S");
  if (!exits.includes("E")) disableBtn("â¡ E");
  if (!exits.includes("W")) disableBtn("â¬… W");
}

function disableBtn(label) {
  document.querySelectorAll("button").forEach(btn=>{
    if(btn.textContent.includes(label)) btn.disabled=true;
  });
}

window.onload = () => {
  document.getElementById("wsurl").value = localStorage.getItem("wsurl") || "";
};
</script>

</body>
</html>
