<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BBS Mobile Client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>

<style>
body {
  margin:0;
  background:black;
  color:white;
  height:100vh;
  display:flex;
  flex-direction:column;
  font-family: monospace;
}

#connectPanel {
  padding:6px;
  background:#222;
}

input, button {
  width:100%;
  padding:10px;
  margin-top:4px;
  font-size:16px;
}

#terminal {
  flex:1;
  overflow-y:auto;
  padding:10px;
  white-space:pre-wrap;
  word-wrap:break-word;
}

#controls {
  background:#111;
  padding:5px;
  display:grid;
  grid-template-columns: repeat(4,1fr);
  gap:5px;
}

.control-btn {
  padding:12px;
  font-size:18px;
}
.hidden { display:none; }
</style>
</head>

<body>

<div id="connectPanel">
  <input id="wsurl" placeholder="WebSocket URL">
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="connect()">Connect</button>
</div>

<div id="terminal"></div>

<div id="controls" class="hidden">
  <button class="control-btn" onclick="sendCmd('N')">â¬† N</button>
  <button class="control-btn" onclick="sendCmd('LOOK')">ğŸ‘</button>
  <button class="control-btn" onclick="sendCmd('S')">â¬‡ S</button>

  <button class="control-btn" onclick="sendCmd('W')">â¬… W</button>
  <button class="control-btn" onclick="sendCmd('HIT')">âš”</button>
  <button class="control-btn" onclick="sendCmd('E')">â¡ E</button>

  <button class="control-btn" onclick="sendCmd('U')">â¬† U</button>
  <button class="control-btn" onclick="sendCmd('SPELLS')">ğŸ“–</button>
  <button class="control-btn" onclick="sendCmd('D')">â¬‡ D</button>

  <button class="control-btn" onclick="sendCmd('I')">ğŸ’</button>
  <button class="control-btn" onclick="toggleKeyboard()">âŒ¨</button>
  <button class="control-btn" onclick="toggleMore()">â•</button>
</div>

<input id="keyboardInput" style="position:absolute;opacity:0;">

<script>
let ws;
const ansi = new AnsiUp();
const terminal = document.getElementById("terminal");
const keyboardInput = document.getElementById("keyboardInput");

function connect() {
  const wsurl = wsurlInput.value;
  const user = username.value;
  const pass = password.value;

  localStorage.setItem("wsurl", wsurl);
  localStorage.setItem("username", user);
  localStorage.setItem("password", pass);

  ws = new WebSocket(wsurl);

  ws.onopen = () => {
    document.getElementById("controls").classList.remove("hidden");
    sendRaw(user);
    sendRaw(pass);
  };

  ws.onmessage = e => {
    handleBbsOutput(e.data);
  };

  ws.onclose = () => terminal.innerHTML += "\n*** Disconnected ***\n";
}

function handleBbsOutput(text) {
  const html = ansi.ansi_to_html(text);
  terminal.innerHTML += html;
  terminal.scrollTop = terminal.scrollHeight;

  // Dynamic button logic
  if (text.includes("You are in combat")) {
    showCombatButtons();
  }
  if (text.includes("Exits:")) {
    updateExitButtons(text);
  }
}

function sendCmd(cmd) {
  ws.send(cmd + "\r\n");
}

function sendRaw(txt) {
  ws.send(txt + "\r\n");
}

function toggleKeyboard() {
  keyboardInput.focus();
}

keyboardInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    sendCmd(keyboardInput.value);
    keyboardInput.value = "";
  }
});

function updateExitButtons(text) {
  // example: "Exits: N S E W"
  const exits = text.match(/Exits:(.*)/);
  if (!exits) return;

  const dirs = exits[1];
  document.querySelectorAll(".control-btn").forEach(b => b.disabled=false);

  if (!dirs.includes("N")) disableBtn("â¬† N");
  if (!dirs.includes("S")) disableBtn("â¬‡ S");
}

function disableBtn(label) {
  document.querySelectorAll("button").forEach(btn=>{
    if(btn.textContent.includes(label)) btn.disabled=true;
  });
}

function showCombatButtons() {
  // future dynamic grouping
  console.log("Combat detected");
}

function toggleMore() {
  alert("Future macro buttons here");
}

// Load saved settings
const wsurlInput = document.getElementById("wsurl");
window.onload = () => {
  wsurlInput.value = localStorage.getItem("wsurl") || "";
  username.value = localStorage.getItem("username") || "";
  password.value = localStorage.getItem("password") || "";
};
</script>

</body>
</html>
