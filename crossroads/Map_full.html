<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Crossroads World Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; background: #1a1a1a; color: white; }
        #cy { width: 100vw; height: 100vh; display: block; }
        #info-panel {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.85); padding: 15px; border-radius: 10px;
            border: 1px solid #444; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            max-height: 30vh; overflow-y: auto; z-index: 10;
        }
        #info-panel.active { opacity: 1; pointer-events: auto; }
        .controls { position: absolute; top: 10px; right: 10px; z-index: 11; display:flex; gap: 5px; }
        button { padding: 10px; background: #333; color: white; border: 1px solid #666; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="controls">
    <button onclick="cy.fit()">Center Map</button>
</div>

<div id="info-panel">
    <h3 id="room-name">Room Name</h3>
    <p id="room-desc">Select a room to see description...</p>
</div>

<div id="cy"></div>

<script>
async function initMap() {
    const response = await fetch('Rooms_Full.json');
    const rooms = await response.json();
    
    const elements = [];
    
    // 1. Create Nodes
    Object.keys(rooms).forEach(id => {
        elements.push({
            data: { 
                id: id, 
                label: id, 
                full: rooms[id] 
            }
        });
    });

    // 2. Create Edges (Exits)
    Object.keys(rooms).forEach(id => {
        const r = rooms[id];
        const exits = ['n', 'e', 's', 'w', 'u', 'd'];
        exits.forEach(dir => {
            const target = String(r[dir]);
            if (target !== "0" && rooms[target]) {
                elements.push({
                    data: { 
                        source: id, 
                        target: target,
                        label: dir.toUpperCase()
                    }
                });
            }
        });
    });

    // 3. Initialize Cytoscape
    window.cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': '#3498db',
                    'label': 'data(id)',
                    'color': '#fff',
                    'font-size': '10px',
                    'text-valign': 'center',
                    'width': '30px', 'height': '30px'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#666',
                    'target-arrow-color': '#666',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'opacity': 0.5
                }
            },
            {
                selector: ':selected',
                style: {
                    'background-color': '#e74c3c',
                    'line-color': '#e74c3c',
                    'target-arrow-color': '#e74c3c',
                    'opacity': 1
                }
            }
        ],
        layout: {
            name: 'cose', // Force-directed layout
            idealEdgeLength: 50,
            nodeOverlap: 20,
            refresh: 20,
            fit: true,
            padding: 30,
            randomize: false,
            componentSpacing: 100,
            nodeRepulsion: 400000,
            edgeElasticity: 100,
            nestingFactor: 5,
            gravity: 80,
            numIter: 1000
        }
    });

    // Handle Clicks/Taps
    cy.on('tap', 'node', function(evt){
        const data = evt.target.data().full;
        document.getElementById('room-name').innerText = `[${evt.target.id()}] ${data.short || 'No Name'}`;
        document.getElementById('room-desc').innerText = data.long || 'No description provided.';
        document.getElementById('info-panel').classList.add('active');
    });

    cy.on('tap', function(evt){
        if(evt.target === cy){
            document.getElementById('info-panel').classList.remove('active');
        }
    });
}

initMap();
</script>
</body>
</html>