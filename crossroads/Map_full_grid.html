<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crossroads Mapper</title>
    <style>
        body { margin: 0; background: #121212; color: #e0e0e0; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; cursor: grab; }
        canvas { display: block; }
        .ui-panel { position: absolute; background: rgba(30, 30, 30, 0.95); border: 1px solid #444; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 100; }
        #top-bar { top: 10px; left: 10px; right: 10px; padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        select { background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; flex-grow: 1; min-width: 150px; cursor: pointer; }
        .btn { background: #444; color: white; border: 1px solid #666; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        #info-panel { bottom: 20px; left: 20px; right: 20px; padding: 15px; max-height: 40vh; overflow-y: auto; display: none; border-bottom: 5px solid #1971c2; }
        #info-panel.active { display: block; }
        .room-selector { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .sel-btn { background: #333; border: 1px solid #555; color: white; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .sel-btn.active { background: #1971c2; border-color: #4dabf7; font-weight: bold; }
        h3 { margin: 0 0 5px 0; color: #4dabf7; font-size: 18px; }
        p { font-size: 14px; margin: 8px 0; color: #ccc; line-height: 1.5; white-space: pre-wrap; }
        .tag { display: inline-block; background: #222; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 5px; border: 1px solid #444; color: #888; }
        #recenter-btn { position: absolute; bottom: 30px; right: 20px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    </style>
</head>
<body>

<div id="top-bar" class="ui-panel">
    <select id="area-select"></select>
    <div style="display:flex; align-items:center; gap:5px;">
        <button class="btn" id="lvl-down">âˆ’</button>
        <div id="level-display">Lvl: 0</div>
        <button class="btn" id="lvl-up">+</button>
    </div>
</div>

<button id="recenter-btn" class="ui-panel btn">ðŸŽ¯</button>

<div id="info-panel" class="ui-panel">
    <div id="room-selector-container" class="room-selector"></div>
    <h3 id="room-name"></h3>
    <div id="room-meta"></div>
    <p id="room-desc"></p>
</div>

<div id="canvas-container"><canvas id="mapCanvas"></canvas></div>

<script>
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const areaSelect = document.getElementById('area-select');
    const infoPanel = document.getElementById('info-panel');
    const roomSelectorContainer = document.getElementById('room-selector-container');
    const levelDisplay = document.getElementById('level-display');
    
    let allData = null, currentAreaRooms = [], currentZ = 0, scale = 55, offset = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    let selectedGroup = null, activeInGroupIndex = 0;
    let isDragging = false, lastPos = { x: 0, y: 0 }, lastDist = 0;

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; draw(); }
    window.addEventListener('resize', resize);
    resize();

    fetch('Rooms_With_Clusters.json').then(res => res.json()).then(data => {
        allData = data;
        populateDropdown();
        
        // Check URL for room ID on load
        const urlParams = new URLSearchParams(window.location.search);
        const startId = urlParams.get('roomId');
        if (startId) {
            focusRoom(startId);
        } else {
            loadArea(data.clusters[0].id);
        }
    });

    // Listen for GOTO messages from index.html
    window.addEventListener('message', (e) => {
        if (e.data.type === 'GOTO_ROOM') focusRoom(e.data.roomId);
    });

    function focusRoom(id) {
        const room = allData.rooms[id];
        if (!room) return;
        const clusterId = allData.clusters.find(c => c.rooms.includes(id))?.id;
        if (!clusterId) return;

        areaSelect.value = clusterId;
        loadArea(clusterId);
        currentZ = room.z;
        levelDisplay.innerText = `Lvl: ${currentZ}`;
        
        // Center view
        offset.x = (window.innerWidth / 2) - (room.x * scale);
        offset.y = (window.innerHeight / 2) + (room.y * scale);
        
        // Select room
        selectedGroup = currentAreaRooms.filter(r => r.x === room.x && r.y === room.y && r.z === room.z);
        activeInGroupIndex = selectedGroup.findIndex(r => r._id === id);
        showInfo();
        draw();
    }

    function populateDropdown() {
        allData.clusters.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id; opt.textContent = c.name;
            areaSelect.appendChild(opt);
        });
    }

    function loadArea(clusterId) {
        const cluster = allData.clusters.find(c => c.id == clusterId);
        currentAreaRooms = cluster.rooms.map(id => ({ ...allData.rooms[id], _id: id }));
        draw();
    }

    function getRoomStyle(keyword) {
        const char = keyword ? keyword.charAt(0).toUpperCase() : '';
        const styles = { 'A': '#898989', 'F': '#fa5252', 'W': '#228be6', 'E': '#40c057' };
        return { bg: styles[char] || '#ffd43b', text: styles[char] ? '#fff' : '#000' };
    }

    function getRoomIcon(id) {
        const icons = { "5054":"ðŸª„","5055":"ðŸ“š","5051":"ðŸ›¡","5050":"âš”","5057":"â¤â€ðŸ©¹","5056":"ðŸº","5053":"ðŸ’Ž","5052":"ðŸ›–","5000":"ðŸ›" };
        return icons[id] || null;
    }

    function draw() {
        if (!currentAreaRooms.length) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const roomSize = scale * 0.85;
        const visibleRooms = currentAreaRooms.filter(r => r.z === currentZ);
        const groups = {};
        visibleRooms.forEach(r => { const k = `${r.x},${r.y}`; if(!groups[k]) groups[k]=[]; groups[k].push(r); });

        ctx.strokeStyle = '#444'; ctx.lineWidth = 2;
        visibleRooms.forEach(r => {
            ['n','e','s','w'].forEach(d => {
                const t = allData.rooms[r[d]];
                if (t && t.z === currentZ && currentAreaRooms.some(cr => cr._id == r[d])) {
                    ctx.beginPath(); ctx.moveTo(r.x * scale + offset.x, -r.y * scale + offset.y);
                    ctx.lineTo(t.x * scale + offset.x, -t.y * scale + offset.y); ctx.stroke();
                }
            });
        });

        Object.values(groups).forEach(g => {
            const r = g[0], vx = r.x * scale + offset.x, vy = -r.y * scale + offset.y;
            const style = getRoomStyle(r.keyword);
            const isSelected = selectedGroup && selectedGroup[0].x === r.x && selectedGroup[0].y === r.y;
            ctx.save();
            ctx.fillStyle = style.bg;
            if (isSelected) { ctx.shadowBlur = 15; ctx.shadowColor = "white"; ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; }
            else { ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.lineWidth = 1; }
            ctx.fillRect(vx - roomSize/2, vy - roomSize/2, roomSize, roomSize);
            ctx.strokeRect(vx - roomSize/2, vy - roomSize/2, roomSize, roomSize);
            if(g.length > 1) { ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.strokeRect(vx - roomSize/2 + 4, vy - roomSize/2 + 4, roomSize - 8, roomSize - 8); }
            ctx.restore();
            if (scale > 15) {
                ctx.fillStyle = style.text; ctx.textAlign = 'center';
                const fz = Math.max(7, Math.floor(scale/6.5)); ctx.font = `bold ${fz}px sans-serif`;
                ctx.fillText(g.map(rm => rm._id).join('/'), vx, vy - (scale/12));
                const icon = getRoomIcon(r._id);
                if (icon) { ctx.font = `${fz * 1.5}px sans-serif`; ctx.fillText(icon, vx, vy + (scale/4)); }
            }
        });
    }

    // Touch/Mouse Controls (Pinch zoom etc)
    const getDist = (t1, t2) => Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
    const onStart = (e) => {
        const t = e.touches;
        if (t && t.length === 2) { isDragging = false; lastDist = getDist(t[0], t[1]); }
        else { isDragging = true; const p = t ? t[0] : e; lastPos = { x: p.clientX, y: p.clientY }; }
    };
    const onMove = (e) => {
        const t = e.touches;
        if (t && t.length === 2) {
            e.preventDefault(); const d = getDist(t[0], t[1]);
            scale = Math.min(Math.max(10, scale * (d / lastDist)), 400); lastDist = d; draw();
        } else if (isDragging) {
            const p = t ? t[0] : e;
            offset.x += p.clientX - lastPos.x; offset.y += p.clientY - lastPos.y;
            lastPos = { x: p.clientX, y: p.clientY }; draw();
        }
    };
    canvas.addEventListener('mousedown', onStart); canvas.addEventListener('touchstart', onStart, { passive: false });
    window.addEventListener('mousemove', onMove); window.addEventListener('touchmove', onMove, { passive: false });
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('touchend', (e) => { if(!e.touches || e.touches.length < 2) lastDist = 0; if(!e.touches || e.touches.length === 0) isDragging = false; });

    canvas.addEventListener('click', e => {
        if (Math.abs(lastPos.x - e.clientX) > 5) return;
        const clicked = currentAreaRooms.filter(r => r.z === currentZ && Math.abs(e.clientX - (r.x * scale + offset.x)) < scale/2 && Math.abs(e.clientY - (-r.y * scale + offset.y)) < scale/2);
        if (clicked.length) { selectedGroup = clicked; activeInGroupIndex = 0; showInfo(); }
        else { selectedGroup = null; infoPanel.classList.remove('active'); }
        draw();
    });

    function showInfo() {
        const activeRoom = selectedGroup[activeInGroupIndex];
        roomSelectorContainer.innerHTML = '';
        if (selectedGroup.length > 1) {
            selectedGroup.forEach((r, i) => {
                const b = document.createElement('button');
                b.className = `sel-btn ${i === activeInGroupIndex ? 'active' : ''}`;
                b.innerText = `Room ${r._id}`;
                b.onclick = (e) => { e.stopPropagation(); activeInGroupIndex = i; showInfo(); };
                roomSelectorContainer.appendChild(b);
            });
            roomSelectorContainer.style.display = 'flex';
        } else { roomSelectorContainer.style.display = 'none'; }
        document.getElementById('room-name').innerText = activeRoom.short.replace(/^\.+/, '');
        document.getElementById('room-desc').innerText = activeRoom.long;
        document.getElementById('room-meta').innerHTML = `<span class="tag">ID: ${activeRoom._id}</span><span class="tag">${activeRoom.keyword}</span>`;
        infoPanel.classList.add('active');
    }

    document.getElementById('recenter-btn').onclick = () => { offset = { x: canvas.width/2, y: canvas.height/2 }; draw(); };
    document.getElementById('lvl-up').onclick = () => { currentZ++; levelDisplay.innerText = `Lvl: ${currentZ}`; draw(); };
    document.getElementById('lvl-down').onclick = () => { currentZ--; levelDisplay.innerText = `Lvl: ${currentZ}`; draw(); };
    canvas.addEventListener('wheel', e => { e.preventDefault(); scale = Math.min(Math.max(10, scale * (e.deltaY > 0 ? 0.9 : 1.1)), 400); draw(); }, { passive: false });
</script>
</body>
</html>
